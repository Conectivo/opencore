<tal:vars tal:define="usr view/user;
                      attachments python:here.getFolderContents(contentFilter = {'portal_type' : ['FileAttachment']});
                      canedit usr/canedit;
                      page view/page;
                      Iterator python:modules['Products.CMFPlone'].IndexIterator;
                      lockable python:hasattr(here, 'wl_isLocked');
                      errors python: options.get('errors', {});
                      isLocked python:lockable and here.wl_isLocked();
                      member python:here.portal_membership.getAuthenticatedMember();
                      portal python:context.portal_url.getPortalObject();
                      portal_url here/portal_url;
                      tabindex python:Iterator(pos=7000);
                      ">

<html metal:use-macro="here/@@standard_macros/master">
  <head>
    <metal:do metal:fill-slot="link" >
      <link rel="stylesheet" tal:attributes="href string:${view/siteURL}/portal_css/Plone%20Default/kupustyles.css" media="all"/>
      <link rel="stylesheet" tal:attributes="href string:${view/siteURL}/portal_css/Plone%20Default/kupuplone.css" media="all"/>
      <link rel="stylesheet" tal:attributes="href string:${view/siteURL}/portal_css/Plone%20Default/kupudrawerstyles.css" media="all"/>
      <style>
        fieldset {
          border: 1px solid;
          padding: 1em;
        }
      </style>
    </metal:do>
    <metal:do metal:fill-slot="script" >
      <script type="text/javascript" tal:attributes="src string:${view/siteURL}/portal_javascripts/Plone%20Default/sarissa.js"></script>
      <script type="text/javascript" tal:attributes="src string:${view/siteURL}/portal_javascripts/Plone%20Default/sarissa_ieemu_xpath.js"></script>
      <script type="text/javascript" tal:attributes="src string:${view/siteURL}/portal_javascripts/Plone%20Default/kupunoi18n.js"></script>
      <script type="text/javascript" tal:attributes="src string:${view/siteURL}/portal_javascripts/Plone%20Default/kupuhelpers.js"></script>
      <script type="text/javascript" tal:attributes="src string:${view/siteURL}/portal_javascripts/Plone%20Default/kupueditor.js"></script>
      <script type="text/javascript" tal:attributes="src string:${view/siteURL}/portal_javascripts/Plone%20Default/kupubasetools.js"></script>
      <script type="text/javascript" tal:attributes="src string:${view/siteURL}/portal_javascripts/Plone%20Default/kupuloggers.js"></script>
      <script type="text/javascript" tal:attributes="src string:${view/siteURL}/portal_javascripts/Plone%20Default/kupucontentfilters.js"></script>
      <script type="text/javascript" tal:attributes="src string:${view/siteURL}/portal_javascripts/Plone%20Default/kupucontextmenu.js"></script>
      <script type="text/javascript" tal:attributes="src string:${view/siteURL}/portal_javascripts/Plone%20Default/kupuploneeditor.js"></script>
      <script type="text/javascript" tal:attributes="src string:${view/siteURL}/portal_javascripts/Plone%20Default/kupuploneinit.js"></script>
      <script type="text/javascript" tal:attributes="src string:${view/siteURL}/portal_javascripts/Plone%20Default/kupusourceedit.js"></script>
      <script type="text/javascript" tal:attributes="src string:${view/siteURL}/portal_javascripts/Plone%20Default/kupudrawers.js"></script>
    </metal:do>
  </head>
  <body>
    <div metal:fill-slot="content">

      <!-- TODO project history -->

      <div id="oc-content-main" class="oc-content-main-fullWidth">

        <div class="oc-wiki">
          <div class="headingBlock oc-wiki-headingBlock">
            <h2 tal:content="view/pagetitle"></h2>
          </div>
          <ul class="oc-tabs">
            <li class="">
              <a href="@@index.html" rel="view">view</a>
            </li>
            <li class="oc-selected">
              <a href="@@edit" rel="edit">edit</a>
            </li>
            <li tal:condition="nothing">
              <a href="" rel="history">history</a>
            </li>
            <li tal:condition="nothing">
              <form class="" >
                <select class="oc-dropdown-links">
                  <option value="">More...</option>
                  <option value="http://www.google.com">I'm feeling lucky</option>
                </select>
                <input type="submit" value="Go" style=""/>
              </form>
            </li>
          </ul><!-- end .oc-tabs -->

          <form name="edit_form"
            method="post"
            enctype="multipart/form-data"
            class="enableUnloadProtection"
            tal:attributes="action python:here.absolute_url()  + '/@@update'">
            
            <div class="oc-wiki-edit" >
              <div class="oc-wiki-edit-content">
                <input type="hidden" name="submitted" value="1"/>
                <metal:fieldMacro use-macro="python:here.widget('text', mode='edit')"/>
              </div><!-- end .oc-wiki-edit-content" --> 

              <ul class="oc-actions oc-wiki-actions">
                <li><input type="submit" value="Save" class="oc-button oc-chooseThis" /></li>
                <li>or <a href="@@index.html">cancel</a></li>
              </ul>  
              
            </div><!-- end .oc-wiki-edit -->
            
          </form>
        </div><!-- end .oc-wiki -->

        <hr />
        <div class="oc-options oc-wiki-edit-options">

          <div class="oc-expander">
              <a href="#oc-wiki-manageAttachments" class="oc-expander-link">manage attachments</a>
              <div class="oc-expander-content">
                <h4>Current attachments:</h4>
                    <ul class="oc-attachments" id="oc-wiki-attachments">
                      <tal:block condition="nocall:attachments">
                        <tal:repeat repeat="attachment attachments">
                          <li metal:use-macro="here/@@wiki_macros/attachment"/>
                        </tal:repeat>
                      </tal:block>
                    </ul>

                  <fieldset>
                    <legend><h4>Upload a new file:</h4></legend>
                     <form metal:use-macro="here/@@wiki_macros/upload"/>
                  </fieldset>


              </div><!-- end expander-content -->
            </div><!-- end expander -->
          <hr />

           <div class="oc-expander" tal:condition="nothing">
              <a href="#oc-wiki-addNote" class="oc-expander-link">add note</a>
              <div id="oc-wiki-addNote" class="oc-expander-content">
              <label for="">Add change note</label>
              
                <textarea rows="2" cols="80"></textarea>
            </div><!-- end .oc-expander-content -->
          </div><!-- end .oc-expander --> 
        </div><!-- end .oc-options -->
        

      </div><!-- end #oc-content-main -->
      
      <hr />
      <h2>Testing - add forms for each possible response type here.</h2>
        <fieldset>
          <legend>404 w/out upload</legend>
          <form class="oc-updateForm" action="/my404" method="post">
            <input type="hidden" name="oc-target" value="oc-target-404" />
            <span class="oc-indicator">Loading...</span>
            <input type="submit" value="Go - 404 w/out upload" />
          </form>
          
          <div id="oc-target-404">
          
          </div>
          
          <p>NOTE: this triggers a proper 404 and calls this.afterFailure()</p>
        </fieldset>
        
        <fieldset>
          <legend>TODO: Success w/out upload</legend>
          <form class="oc-updateForm" action="/myPage" method="post">
            <input type="hidden" name="oc-target" value="oc-target-success" />
            <span class="oc-indicator">Loading...</span>
            <input type="submit" value="Go - Success w/out upload" />
          </form>
          
          <div id="oc-target-success">
          
          </div>
          
          <p>NOTE: this should return a proper response and call this.afterSuccess()</p>
        </fieldset>
        
        <fieldset>
          <legend>Upload hits 404</legend>
          <form class="oc-updateForm" action="/my404" method="post" enctype="multipart/form-data">
            <input type="hidden" name="oc-target" value="oc-target-upload-404" />
            <input type="file" name="myfile" />
            <span class="oc-indicator">Loading...</span>
            <input type="submit" value="Go - Upload hits 404" />
          </form>
          <div id="oc-target-upload-404">
          
          </div>
          <p>NOTE: this does not trigger a real 404 response.  Instead, it calls this.afterUpload and sends response HTML</p>
        </fieldset>
        
        <fieldset>
          <legend>TODO: Upload failure, but not 404</legend>
          <form class="oc-updateForm" action="" method="post" enctype="multipart/form-data">
            <input type="hidden" name="oc-target" value="oc-target-upload-failure" />
            <input type="file" name="myfile" />
            <span class="oc-indicator">Loading...</span>
            <input type="submit" value="Go - Upload failure (non 404)" />
          </form>
          <div id="oc-target-upload-failure">
          
          </div>
          <p>We will have to parse the error code/message from the response HTML</p>
        </fieldset>
        
        <fieldset>
          <legend>TODO: Upload success</legend>
          <form class="oc-updateForm" action="" method="post" enctype="multipart/form-data">
            <input type="hidden" name="oc-target" value="oc-target-upload-success" />
            <input type="file" name="myfile" />
            <span class="oc-indicator">Loading...</span>
            <input type="submit" value="Go - Upload success" />
          </form>
          <div id="oc-target-upload-success">
          
          </div>
          <p>We will have to parse the error code/message from the response HTML</p>
        </fieldset>
        
        
        
    </div><!-- end content slot -->
  </body>
  
</html>

</tal:vars>
