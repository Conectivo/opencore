===================
 Project deletions
===================

Project deletion cascades a number of other events: external and
internal app deletion and the removal of the corresponding team and
all the memberships.

First, let's test our deletion handlers directly::

    >>> project = self.projects.p1

Let's add some featurelets::

    >>> self.loginAsPortalOwner() #@@ this should be the project owner

    >>> IFeatureletSupporter(project).installFeaturelet(TaskTrackerFeaturelet(project))
    Called httplib2.Http.request(
        'http://nohost:tasktracker/project/initialize/',
        headers={'X-Openplans-Project': 'p1', 'X-Openplans-Tasktracker-Initialize': 'True', 'Cookie': '__ac=...'},
        method='POST')

    >>> IFeatureletSupporter(project).installFeaturelet(ListenFeaturelet(project))

Flet Removal
============

    >>> from opencore.project.browser.preferences import handle_flet_uninstall

Tasks are now deleted from a project, and the message is sent through
cabochon::

    >>> handle_flet_uninstall(project) 

Gotta reinstall::    

    >>> IFeatureletSupporter(project).installFeaturelet(TaskTrackerFeaturelet(project))
    Called...


Team removal
============

    >>> from opencore.project.browser.preferences import delete_team

Make sure delete_team does what it's supposed to; we'll kill a team we
don't need for this test::

    >>> p4_proj = self.projects.p4
    >>> delete_team(p4_proj)
    >>> sorted(self.portal.portal_teams.objectIds())
    ['.wf_policy_config', 'p1', 'p2', 'p3']


Put it all together
===================

    >>> project.getTeams()
    [<OpenTeam at /plone/portal_teams/p1>]

    >>> view = project.restrictedTraverse('delete')
    >>> view
    <...project/browser/delete.pt...>

    >>> deleting = view._handle_delete()
    opencore.testing.utility.StubCabochonClient: uri: p1

    >>> deleting
    True

Free up the references::

    >>> del project
    >>> del view

p1 should be gone::

    >>> sorted(self.projects.objectIds())
    ['.wf_policy_config', 'p2', 'p3', 'p4']

The team should also be gone::

    >>> sorted(self.portal.portal_teams.objectIds())
    ['.wf_policy_config', 'p2', 'p3']

We redirect to the account page after project deletion::

    >>> print self.request.RESPONSE.headers['location']
    /account

What else? [test wp, tt, removal]








