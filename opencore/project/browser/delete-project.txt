===================
 Project deletions
===================

Project deletion cascades a number of other events: external and
internal app deletion and the removal of the corresponding team and
all the memberships.

First, let's test our deletion handlers directly::

    >>> project = self.projects.p1

Let's add some featurelets::

    >>> self.loginAsPortalOwner() #@@ this should be the project owner

    >>> IFeatureletSupporter(project).installFeaturelet(TaskTrackerFeaturelet(project))
    Called httplib2.Http.request(
        'http://nohost:tasktracker/project/initialize/',
        headers={'X-Openplans-Project': 'p1', 'X-Openplans-Tasktracker-Initialize': 'True', 'Cookie': '__ac=...'},
        method='POST')

    >>> IFeatureletSupporter(project).installFeaturelet(ListenFeaturelet(project))

Flet Removal
============

    >>> from opencore.project.browser.preferences import handle_flet_uninstall

Tasks are now deleted from a project, and the message is sent through
cabochon::

    >>> handle_flet_uninstall(project) 

Gotta reinstall::    

    >>> IFeatureletSupporter(project).installFeaturelet(TaskTrackerFeaturelet(project))
    Called...


Add some invites
======================

    >>> mt_view = project.restrictedTraverse('manage-team')
    >>> mt_view
    <Products.Five.metaclass.ManageTeamView object at ...>
    >>> team = project.getTeams()[0]
    >>> team.manage_delObjects(ids=['m3']) # <-- remove to re-add
    >>> team.addMember('m3')
    <OpenMembership at ...m3>
    >>> inviteview = project.restrictedTraverse('invite')
    >>> self.clearMemoCache()
    >>> inviteview.request.form.clear()
    >>> invites = 'doesnotexist@example.com, isnotthere@example.com'
    >>> inviteview.request.form.update({'task|email-invites': 'Send',
    ...                                 'email-invites': invites})
    >>> inviteview.add_email_invites()
    >>> len(mt_view.pending_invitations)
    1
    >>> len(mt_view.pending_email_invites)
    2


Team removal
============

    >>> from opencore.project.browser.preferences import delete_team

Make sure delete_team does what it's supposed to; we'll kill a team we
don't need for this test::

    >>> p4_proj = self.projects.p4
    >>> delete_team(p4_proj)
    >>> sorted(self.portal.portal_teams.objectIds())
    ['.wf_policy_config', 'p1', 'p2', 'p3']


Put it all together
===================


The project has a team::

    >>> project.getTeams()
    [<OpenTeam at /plone/portal_teams/p1>]

Let's give the project a list featurelet too::

    >>> IFeatureletSupporter(project).installFeaturelet(ListenFeaturelet(project))
    >>> ll = getUtility(IListLookup)
    >>> pprint(ll.showAddressMapping())
    [{'address': 'p1-discussion@...',
      'path': '/plone/projects/p1/lists/p1-discussion'}]


Get the delete view and invoke it::

    >>> view = project.restrictedTraverse('delete')
    >>> view
    <...project/browser/delete.pt...>

    >>> deleting = view._handle_delete()

##    opencore.testing.utility.StubCabochonClient: args: ('p1',)

    >>> deleting
    True

Free up the references::

    >>> del project
    >>> del view

p1 should be gone::

    >>> sorted(self.projects.objectIds())
    ['.wf_policy_config', 'p2', 'p3', 'p4']

The team should also be gone::

    >>> sorted(self.portal.portal_teams.objectIds())
    ['.wf_policy_config', 'p2', 'p3']

We redirect to the account page after project deletion::

    >>> print self.request.RESPONSE.headers['location']
    /account

The invites have been deleted::

    >>> self.clearMemoCache()
    >>> len(mt_view.pending_invitations)
    0
    >>> len(mt_view.pending_email_invites)
    0


The project's lists are gone from the list lookup utility too::

    >>> pprint(ll.showAddressMapping())
    []

What else? [test wp, tt, removal]
